{"version":3,"file":"view.min.js","sources":["../src/view.js"],"sourcesContent":["// This file is part of the block_mylearning plugin for Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * My Learning block overview module.\n *\n * @module     block_mylearning/view\n * @copyright  2018 Moodle Pty Ltd <support@moodle.com>\n * @author     2018 David Matamoros <davidmc@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or late\n */\n\ndefine(['jquery', 'core/ajax', 'core/notification'], function($, ajax, Notification) {\n\n    var SELECTOR = {\n        ALL: '.dashboard-item',\n        CERTIFICATIONNAME: '[data-region=\"certificationname\"]',\n        CONTROLREGION: '[data-region=\"dashboard-controls\"]',\n        COMPLETED: '.dashboard-item[data-completed=\"1\"]',\n        COURSES: '.dashboard-item[data-courses=\"1\"]',\n        COURSENAME: '[data-region=\"course-call-to-action\"]',\n        NOTCOMPLETED: '.dashboard-item:not([data-completed=\"1\"])',\n        PROGRAMS: '.dashboard-item[data-programs=\"1\"]',\n        MYLEARNINGDISPLAYDROPDOWN: '#mylearning-display-dropdown',\n        MYLEARNINGDISPLAYDROPDOWNITEM: '.mylearning-display .dropdown-item',\n        LEARNINGITEMNAME: '[data-region=\"mylearningname\"]',\n        MYLEARNINGSORTINGSDROPDOWN: '#mylearning-sorting-dropdown',\n        MYLEARNINGSORTINGSDROPDOWNITEM: '.mylearning-sorting .dropdown-item',\n        MYLEARNINGREGION: '[data-region=\"mylearning-overview-view\"]',\n        MYLEARNINGSTATUSDROPDOWN: '#mylearning-status-filter-dropdown',\n        MYLEARNINGSTATUSDROPDOWNITEM: '.mylearning-status-filter .dropdown-item',\n        MYLEARNINGSEARCHINPUT: '[data-region=\"mylearning-search-input\"]',\n        ENROLTOCOURSE: '.enrol_to_course',\n    };\n\n    var MYLEARNINGFILTER = {\n        SHOW: 'filter-visible',\n        HIDE: 'filter-hidden'\n    };\n\n    var SEARCHFILTER = {\n        SHOW: 'search-visible',\n        HIDE: 'search-hidden'\n    };\n\n    /**\n     * Enrol a user into a course.\n     *\n     * @param {Number} courseid\n     * @param {Number} programid\n     */\n    var enrolUserToCourse = function(courseid, programid) {\n        var promises = ajax.call([\n            {methodname: 'tool_program_enrol_user_to_course', args: {courseid: courseid, programid: programid}}\n        ]);\n        promises[0].done(function(response) {\n            if (response.status && response.redirecturl) {\n                window.location.href = response.redirecturl;\n            }\n        }).fail(Notification.exception);\n    };\n\n    /**\n     * Filter for programs.\n     *\n     * @param {Element} region\n     * @param {String} selector\n     * @param {String} visibility\n     */\n    var filterLearningItems = function(region, selector, visibility) {\n        let elements = region.find(selector);\n        if (elements.length === 0) {\n            $('.nothingtodisplay').show();\n        } else {\n            $('.nothingtodisplay').hide();\n            elements.each(function() {\n                $(this).removeClass(MYLEARNINGFILTER.SHOW).removeClass(MYLEARNINGFILTER.HIDE);\n                $(this).addClass(visibility);\n            });\n        }\n    };\n\n    /**\n     * Update user preferences.\n     *\n     * @param {String} type\n     * @param {String} value\n     */\n    var updateUserPreferences = function(type, value) {\n        var request = {\n            methodname: 'core_user_update_user_preferences',\n            args: {\n                preferences: [{\n                    type: type,\n                    value: value,\n                }]\n            }\n        };\n\n        ajax.call([request])[0]\n            .fail(Notification.exception);\n    };\n\n    /**\n     * Show/Hide 'Nothing to display' content.\n     *\n     * @param {String} regionSelector\n     */\n    var checkNothingToDisplay = function(regionSelector) {\n        const learningRegion = $(regionSelector + ' ' + SELECTOR.MYLEARNINGREGION);\n        let visibleElements = learningRegion.find(SELECTOR.ALL + ':visible');\n        if (visibleElements.length === 0) {\n            learningRegion.find('.nothingtodisplay').show();\n        } else {\n            learningRegion.find('.nothingtodisplay').hide();\n        }\n    };\n\n    /**\n     * Show programs matching a status\n     *\n     * @param {String} regionSelector\n     * @param {String} programfilter\n     */\n    var showLearningItemsWithStatus = function(regionSelector, programfilter) {\n        M.util.js_pending('block_mylearning_filterstatus'); // Tell Behat to wait.\n        const learningRegion = $(regionSelector + ' ' + SELECTOR.MYLEARNINGREGION);\n        learningRegion.hide();\n        // We hide all programs and show the selected ones.\n        filterLearningItems(learningRegion, SELECTOR.ALL, MYLEARNINGFILTER.HIDE);\n        filterLearningItems(learningRegion, SELECTOR[programfilter.toUpperCase()], MYLEARNINGFILTER.SHOW);\n        updateUserPreferences('block_mylearning_status_filter', programfilter);\n        learningRegion.fadeIn('fast', function() {\n            M.util.js_complete('block_mylearning_filterstatus');\n        });\n    };\n\n    /**\n     * Update mylearning block display\n     *\n     * @param {String} regionSelector\n     * @param {String} displaytype\n     */\n    var updateMylearningDisplay = function(regionSelector, displaytype) {\n        const learningRegion = $(regionSelector + ' ' + SELECTOR.MYLEARNINGREGION);\n        learningRegion.removeClass('viewcards').removeClass('viewlist').addClass(displaytype);\n        updateUserPreferences('block_mylearning_view_filter', displaytype);\n    };\n\n    /**\n     * Update program sorting.\n     *\n     * @param {String} regionSelector\n     * @param {String} sortorder\n     */\n    var updateMylearningSorting = function(regionSelector, sortorder) {\n        const learningRegion = $(regionSelector + ' ' + SELECTOR.MYLEARNINGREGION);\n        let programs = learningRegion.find(SELECTOR.ALL);\n        // Sort by element name.\n        if (sortorder === 'mylearningname') {\n            programs.sort((a, b) => {\n                let mylearningNameA = $(a).find(SELECTOR.LEARNINGITEMNAME).text();\n                let mylearningNameB = $(b).find(SELECTOR.LEARNINGITEMNAME).text();\n                return mylearningNameA.localeCompare(mylearningNameB);\n            });\n            // Sort by element near conclusion date.\n        } else if (sortorder === 'duedate') {\n            programs.sort((a, b) => {\n                return $(a).data(\"lowestduedate\") - $(b).data(\"lowestduedate\");\n            });\n            // Sort by element last access date.\n        } else if (sortorder === 'lastaccess') {\n            programs.sort((a, b) => {\n                // If lastaccess is the same order by name to be consistent with the app.\n                if ($(b).data(\"lastaccess\") === $(a).data(\"lastaccess\")) {\n                    const compareA = $(a).find(SELECTOR.LEARNINGITEMNAME).text().toLowerCase(),\n                        compareB = $(b).find(SELECTOR.LEARNINGITEMNAME).text().toLowerCase();\n                    return compareA.localeCompare(compareB);\n                }\n                return $(b).data(\"lastaccess\") - $(a).data(\"lastaccess\");\n            });\n        }\n        // Update the elements list.\n        learningRegion.remove(SELECTOR.ALL).prepend(programs);\n        // Update the user preferences.\n        updateUserPreferences('block_mylearning_sort_filter', sortorder);\n        // Add a little visual affect to show something is happening.\n        learningRegion.hide().fadeIn('fast');\n    };\n\n    /**\n     * Show matching programs.\n     *\n     * @param {String} regionSelector\n     * @param {String} query string\n     */\n    var showMatchingLearningItems = function(regionSelector, query) {\n        const learningRegion = $(regionSelector + ' ' + SELECTOR.MYLEARNINGREGION);\n        learningRegion.find(SELECTOR.ALL).filter(function() {\n            let learningItem = $(this);\n            let dashboardText = learningItem.find(SELECTOR.LEARNINGITEMNAME).text();\n            dashboardText += ' ' + learningItem.find(SELECTOR.COURSENAME).text();\n            dashboardText += ' ' + learningItem.find(SELECTOR.CERTIFICATIONNAME).text();\n            if (dashboardText.toLowerCase().indexOf(query) > -1) {\n                learningItem.removeClass(SEARCHFILTER.HIDE).addClass(SEARCHFILTER.SHOW);\n            } else {\n                learningItem.removeClass(SEARCHFILTER.SHOW).addClass(SEARCHFILTER.HIDE);\n            }\n            return true;\n        });\n    };\n\n    return {\n        /**\n         * Initialises mylearning overview.\n         *\n         * @param {string} regionSelector\n         */\n        init: function(regionSelector) {\n            const learningRegion = $(regionSelector);\n\n            // Maincontent anchor hack to mantain accesibility.\n            $(\"#maincontent\").detach().prependTo('#region-main');\n\n            // Dispatch resize event to correctly recalculate visible courses for recently accessed courses block.\n            $('body').on('shown shown.bs.tab', function() {\n                window.dispatchEvent(new Event('resize'));\n            });\n\n            // Load correct filter saved in user preferences.\n            if ($(SELECTOR.MYLEARNINGREGION).data('showfilters') === 1) {\n                let statusValue = $(regionSelector + ' ' + SELECTOR.MYLEARNINGSTATUSDROPDOWN).data('selected');\n                let displayValue = $(regionSelector + ' ' + SELECTOR.MYLEARNINGDISPLAYDROPDOWN).data('selected');\n                let sortingValue = $(regionSelector + ' ' + SELECTOR.MYLEARNINGSORTINGSDROPDOWN).data('selected');\n                showLearningItemsWithStatus(regionSelector, statusValue);\n                checkNothingToDisplay(regionSelector);\n                updateMylearningDisplay(regionSelector, displayValue);\n                updateMylearningSorting(regionSelector, sortingValue);\n            }\n\n            $(\".section_expand\").click(function(e) {\n                e.preventDefault();\n                $(this).next('.content').toggle();\n                $(this).find('[class$=\"-icon-container\"]').toggle();\n            });\n\n            learningRegion\n                .on('click', SELECTOR.ENROLTOCOURSE, function(e) {\n                    e.preventDefault();\n                    enrolUserToCourse($(this).data('courseid'), $(this).data('programid'));\n                })\n                // Event listener for statusses.\n                .on('click', SELECTOR.MYLEARNINGSTATUSDROPDOWNITEM, function(e) {\n                    e.preventDefault();\n                    showLearningItemsWithStatus(regionSelector, $(this).data('value'));\n                    checkNothingToDisplay(regionSelector);\n                })\n                // Event listener for the view type.\n                .on('click', SELECTOR.MYLEARNINGDISPLAYDROPDOWNITEM, function(e) {\n                    e.preventDefault();\n                    updateMylearningDisplay(regionSelector, $(this).data('value'));\n                })\n                // Event listener for sorting learning items.\n                .on('click', SELECTOR.MYLEARNINGSORTINGSDROPDOWNITEM, function(e) {\n                    e.preventDefault();\n                    updateMylearningSorting(regionSelector, $(this).data('value'));\n                })\n                .on('keyup', SELECTOR.MYLEARNINGSEARCHINPUT, function() {\n                    var query = $(this).val().toLowerCase().trim();\n                    showMatchingLearningItems(regionSelector, query);\n                    checkNothingToDisplay(regionSelector);\n                });\n        }\n    };\n});\n"],"names":["define","$","ajax","Notification","SELECTOR","ALL","CERTIFICATIONNAME","CONTROLREGION","COMPLETED","COURSES","COURSENAME","NOTCOMPLETED","PROGRAMS","MYLEARNINGDISPLAYDROPDOWN","MYLEARNINGDISPLAYDROPDOWNITEM","LEARNINGITEMNAME","MYLEARNINGSORTINGSDROPDOWN","MYLEARNINGSORTINGSDROPDOWNITEM","MYLEARNINGREGION","MYLEARNINGSTATUSDROPDOWN","MYLEARNINGSTATUSDROPDOWNITEM","MYLEARNINGSEARCHINPUT","ENROLTOCOURSE","MYLEARNINGFILTER","SEARCHFILTER","filterLearningItems","region","selector","visibility","elements","find","length","show","hide","each","this","removeClass","addClass","updateUserPreferences","type","value","request","methodname","args","preferences","call","fail","exception","checkNothingToDisplay","regionSelector","learningRegion","showLearningItemsWithStatus","programfilter","M","util","js_pending","toUpperCase","fadeIn","js_complete","updateMylearningDisplay","displaytype","updateMylearningSorting","sortorder","programs","sort","a","b","mylearningNameA","text","mylearningNameB","localeCompare","data","compareA","toLowerCase","compareB","remove","prepend","init","detach","prependTo","on","window","dispatchEvent","Event","statusValue","displayValue","sortingValue","click","e","preventDefault","next","toggle","courseid","programid","done","response","status","redirecturl","location","href","query","val","trim","filter","learningItem","dashboardText","indexOf","showMatchingLearningItems"],"mappings":"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"}